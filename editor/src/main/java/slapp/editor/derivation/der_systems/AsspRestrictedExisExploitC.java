package slapp.editor.derivation.der_systems;

import com.gluonhq.richtextarea.RichTextArea;
import com.gluonhq.richtextarea.model.Document;
import javafx.event.ActionEvent;
import javafx.scene.text.Text;
import javafx.scene.text.TextFlow;
import javafx.util.Pair;
import slapp.editor.decorated_rta.BoxedDRTA;
import slapp.editor.derivation.DCheck;
import slapp.editor.derivation.DerivationCheck;
import slapp.editor.derivation.DerivationExercise;
import slapp.editor.derivation.ViewLine;
import slapp.editor.derivation_explain.DrvtnExpCheck;
import slapp.editor.derivation_explain.DrvtnExpExercise;
import slapp.editor.main_window.Exercise;
import slapp.editor.parser.MatchUtilities;
import slapp.editor.parser.ParseUtilities;
import slapp.editor.parser.TextMessageException;

import java.util.Collections;
import java.util.List;

public class AsspRestrictedExisExploitC extends DerivationRule {

    public AsspRestrictedExisExploitC(String name, String rgexTemplate) {
        super(name, rgexTemplate);
        this.premAssp = true;
    }

    public Pair<Boolean, List<Text>> applies(DCheck checker, ViewLine line, String... inputs) {


        ViewLine bottomLine = checker.lastLineAtScope(line);

        BoxedDRTA bottomDRTA = bottomLine.getLineContentBoxedDRTA();
        RichTextArea bottomRTA = bottomDRTA.getRTA();
        bottomRTA.getActionFactory().saveNow().execute(new ActionEvent());
        Document bottomLineDoc = bottomRTA.getDocument();

        String openBracketString = checker.getDerivationRuleset().getMetaLanguage().getOpenBracket1();
        String closeBracketString = checker.getDerivationRuleset().getMetaLanguage().getCloseBracket1();
        Document bottomForm1 = new Document("\u22a5" );
        Document bottomForm2 = new Document(openBracketString + "\ud835\udcac \u2227 \u223c\ud835\udcac" + closeBracketString);

        //check for second assumption line
        boolean secondLineOK = false;
        List<ViewLine> viewLines = checker.getViewLines();
        int lineIndex = viewLines.indexOf(line);


        ViewLine lineBelow = (checker instanceof DerivationCheck) ? ((DerivationExercise) checker.getExercise()).getContentLineBelow(lineIndex) :
                ((DrvtnExpExercise) checker.getExercise()).getContentLineBelow(lineIndex);
        if (!lineBelow.equals(line) && !lineBelow.equals(bottomLine)) {
            if (line.getDepth() == lineBelow.getDepth()) {
                BoxedDRTA lineBelowDRTA = lineBelow.getLineContentBoxedDRTA();
                RichTextArea lineBelowRTA = lineBelowDRTA.getRTA();
                lineBelowRTA.getActionFactory().saveNow().execute(new ActionEvent());
                Document lineBelowDoc = lineBelowRTA.getDocument();

                if (!lineBelowDoc.getText().equals("")) {
                    TextFlow lineBelowJustFlow = lineBelow.getJustificationFlow();

                    String lineBelowJustificationString = (checker instanceof DerivationCheck) ? ((DerivationExercise) checker.getExercise()).getStringFromJustificationFlow(lineBelowJustFlow) :
                            ((DrvtnExpExercise) checker.getExercise()).getStringFromJustificationFlow(lineBelowJustFlow);
                    if (lineBelowJustificationString.equals("")) {
                        secondLineOK = true;
                    }
                }
            }
        }
        if (!secondLineOK) {
            return new Pair(false, Collections.singletonList(ParseUtilities.newRegularText("An assumption for existential exploitation takes up two lines at the same scope, the second without separate justification.")));
        }


        //check for empty last line
        if (bottomLineDoc.getText().equals("")) {
            String bottomLineLabel = bottomLine.getLineNumberLabel().getText();
            return new Pair(false, Collections.singletonList(ParseUtilities.newRegularText("To complete this exit strategy, indicate contradiction as target at the bottom of the scope line (" +  checker.getContradictionSymbolString() + " ok).")));
        }





        // check for contradiction
        MatchUtilities.clearFormMatch();
        boolean resultGood1 = false;
        boolean resultGood2 = false;
        try {
            Pair<Boolean, Boolean> bottomMatch1 = MatchUtilities.simpleFormMatch(bottomForm1, bottomLineDoc, checker.getDerivationRuleset().getObjectLanguage().getNameString(), checker.getDerivationRuleset().getMetaLanguage().getNameString());
            resultGood1 = true;
        } catch (TextMessageException e) { }

        try {
            Pair<Boolean, Boolean> bottomMatch2 = MatchUtilities.simpleFormMatch(bottomForm2, bottomLineDoc, checker.getDerivationRuleset().getObjectLanguage().getNameString(), checker.getDerivationRuleset().getMetaLanguage().getNameString());
            resultGood2 = true;
        } catch (TextMessageException e) { }

        if (resultGood1 || resultGood2) {
            return new Pair(true, null);
        }
        else {
            String bottomLineLabel = bottomLine.getLineNumberLabel().getText();
            return new Pair(false, Collections.singletonList(ParseUtilities.newRegularText("It looks like your exit strategy should have been \ud835\udc54 rather than \ud835\udc50).")));
        }






    }


}
